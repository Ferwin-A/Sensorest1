<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitor DS18B20 IoT</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
.glass-panel {
    background: rgba(30, 41, 59, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}
.temp-rise { color: #22c55e; } /* verde */
.temp-fall { color: #ef4444; } /* rojo */
.temp-stable { color: #38bdf8; } /* celeste */
</style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen bg-[url('https://images.unsplash.com/photo-1504384308090-c894fdcc538d?q=80&w=2000&auto=format&fit=crop')] bg-cover bg-center bg-fixed">

<div class="fixed inset-0 bg-slate-900/80 pointer-events-none"></div>

<div class="relative z-10 max-w-lg mx-auto p-4 min-h-screen flex flex-col">

<header class="flex justify-between items-center py-6">
    <div>
        <h1 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-blue-300 text-transparent bg-clip-text">DS18B20 IoT Monitor</h1>
        <p class="text-xs text-slate-400">Temperaturas en tiempo real</p>
    </div>
    <button onclick="openConfig()" class="p-2 rounded-full bg-slate-800 hover:bg-slate-700 border border-slate-600">
        <i data-lucide="settings" class="w-5 h-5"></i>
    </button>
</header>

<!-- Estado conexión -->
<div id="statusIndicator" class="mb-6 flex items-center gap-3 bg-red-500/10 border border-red-500/20 p-3 rounded-lg">
    <span class="h-3 w-3 rounded-full bg-red-500"></span>
    <span class="text-sm font-medium text-red-400">Desconectado</span>
</div>

<!-- Sensores -->
<main class="space-y-6">

<!-- Sensor 1 -->
<div id="sensor1" class="glass-panel p-6 rounded-2xl">
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-semibold">Sensor 1</h2>
        <i id="icon1" data-lucide="thermometer" class="w-8 h-8 text-slate-400"></i>
    </div>
    <p id="temp1" class="text-4xl font-bold">-- °C</p>
    <p class="text-xs text-slate-400 font-mono mt-1">/sensores/t1</p>
</div>

<!-- Sensor 2 -->
<div id="sensor2" class="glass-panel p-6 rounded-2xl">
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-semibold">Sensor 2</h2>
        <i id="icon2" data-lucide="thermometer" class="w-8 h-8 text-slate-400"></i>
    </div>
    <p id="temp2" class="text-4xl font-bold">-- °C</p>
    <p class="text-xs text-slate-400 font-mono mt-1">/sensores/t2</p>
</div>

<!-- Sensor 3 -->
<div id="sensor3" class="glass-panel p-6 rounded-2xl">
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-semibold">Sensor 3</h2>
        <i id="icon3" data-lucide="thermometer" class="w-8 h-8 text-slate-400"></i>
    </div>
    <p id="temp3" class="text-4xl font-bold">-- °C</p>
    <p class="text-xs text-slate-400 font-mono mt-1">/sensores/t3</p>
</div>

<!-- Sensor 4 -->
<div id="sensor4" class="glass-panel p-6 rounded-2xl">
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-semibold">Sensor 4</h2>
        <i id="icon4" data-lucide="thermometer" class="w-8 h-8 text-slate-400"></i>
    </div>
    <p id="temp4" class="text-4xl font-bold">-- °C</p>
    <p class="text-xs text-slate-400 font-mono mt-1">/sensores/t4</p>
</div>

<!-- Promedio -->
<div id="avgSensor" class="glass-panel p-6 rounded-2xl">
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-semibold">Promedio</h2>
        <i id="iconAvg" data-lucide="activity" class="w-8 h-8 text-slate-400"></i>
    </div>
    <p id="tempAvg" class="text-4xl font-bold">-- °C</p>
    <p class="text-xs text-slate-400 font-mono mt-1">/sensores/promedio</p>
</div>

</main>

<footer class="mt-6 text-center text-xs text-slate-500 font-mono">
IST Vida Nueva - Investigación IoT
</footer>
</div>

<!-- Modal Configuración -->
<div id="configModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 hidden">
<div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-11/12 max-w-md">
    <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
        <i data-lucide="database" class="w-5 h-5 text-blue-400"></i>
        Configuración Firebase
    </h3>
    <div class="space-y-4">
        <div>
            <label class="text-xs text-slate-400">API KEY</label>
            <input id="apiKeyInput" class="w-full bg-slate-800 p-3 rounded-lg border border-slate-700 mt-1">
        </div>
        <div>
            <label class="text-xs text-slate-400">DATABASE URL</label>
            <input id="dbUrlInput" class="w-full bg-slate-800 p-3 rounded-lg border border-slate-700 mt-1">
        </div>
    </div>
    <div class="mt-6 flex gap-3">
        <button onclick="closeConfig()" class="flex-1 py-3 text-slate-400">Cancelar</button>
        <button onclick="saveConfig()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl">Guardar</button>
    </div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

let db;
let lastTemp = [null, null, null, null, null]; // 4 sensores + promedio

window.openConfig = () => configModal.classList.remove("hidden");
window.closeConfig = () => configModal.classList.add("hidden");

window.saveConfig = () => {
    const api = apiKeyInput.value.trim();
    const url = dbUrlInput.value.trim();

    if (!api || !url) {
        Swal.fire("Error", "Debes llenar ambos campos", "error");
        return;
    }

    localStorage.setItem("iot_api_key", api);
    localStorage.setItem("iot_db_url", url);

    initFirebase(api, url);
    closeConfig();
};

function initFirebase(apiKey, databaseURL) {
    const app = initializeApp({ apiKey, databaseURL });
    db = getDatabase(app);

    updateStatusUI(true);

    // Sensores 1-4
    for (let i = 1; i <= 4; i++) {
        const path = `sensores/t${i}`;
        onValue(ref(db, path), snap => {
            updateTempUI(i, snap.val());
        });
    }

    // Promedio
    onValue(ref(db, 'sensores/promedio'), snap => {
        updateTempUI(5, snap.val());
    });
}

function updateTempUI(i, temp) {
    const el = document.getElementById(`temp${i}`) || document.getElementById(`tempAvg`);
    const icon = document.getElementById(`icon${i}`) || document.getElementById(`iconAvg`);

    if (temp == null) return;

    if (lastTemp[i-1] !== null) {
        if (temp > lastTemp[i-1]) {
            icon.dataset.lucide = "trending-up";
            el.className = "text-4xl font-bold temp-rise";
        } else if (temp < lastTemp[i-1]) {
            icon.dataset.lucide = "trending-down";
            el.className = "text-4xl font-bold temp-fall";
        } else {
            icon.dataset.lucide = "minus";
            el.className = "text-4xl font-bold temp-stable";
        }
        lucide.createIcons();
    }

    el.innerText = temp.toFixed(2) + " °C";
    lastTemp[i-1] = temp;
}

function updateStatusUI(connected) {
    const el = document.getElementById("statusIndicator");
    if (connected) {
        el.className = "mb-6 flex items-center gap-3 bg-emerald-500/10 border border-emerald-500/20 p-3 rounded-lg";
        el.innerHTML = `<span class="h-3 w-3 bg-emerald-500 rounded-full"></span><span class="text-sm text-emerald-400">Conectado a Firebase</span>`;
    }
}

// Cargar configuración guardada
const savedAPI = localStorage.getItem("iot_api_key");
const savedURL = localStorage.getItem("iot_db_url");

if (savedAPI && savedURL) {
    apiKeyInput.value = savedAPI;
    dbUrlInput.value = savedURL;
    initFirebase(savedAPI, savedURL);
} else {
    setTimeout(openConfig, 800);
}

lucide.createIcons();
</script>

</body>
</html>
